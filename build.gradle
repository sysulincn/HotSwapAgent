
/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at https://docs.gradle.org/5.0/userguide/tutorial_java_projects.html
 */


apply plugin: 'java'
apply plugin: 'java-library-distribution'


compileJava.options.encoding = 'UTF8'

repositories {
    // Use jcenter for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
    jcenter()
}

dependencies {
    compile group: 'org.dom4j', name: 'dom4j', version: '2.1.0'
    compile files("lib/jdk_1.8.0_91_b14_linux_tools.jar")
    compile group: 'args4j', name: 'args4j', version: '2.33'
    // https://mvnrepository.com/artifact/org.ow2.asm/asm
    compile group: 'org.ow2.asm', name: 'asm', version: '7.0'
}

jar {
    baseName = 'hotSwapAgent'
    manifest {
        attributes(
                'Agent-Class': 'main.InjectedAgent',
                'Can-Redefine-Classes': 'true',
                'Can-Retransform-Classes': 'true'
        )
    }
}

buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'org.hidetake:gradle-ssh-plugin:2.9.0'
    }
}

apply plugin: 'org.hidetake.ssh' //这个插件只能在gradle 4.x下运行，5.0运行会出现问题

ssh.settings {
    knownHosts = allowAnyHosts
}

remotes {
    ftc {
        host = '10.17.2.25'
        user = 'root'
        password = '000000'
    }
}

task testHotSwapAgent {
    dependsOn distZip
    doLast {
        ssh.run {
            session(remotes.ftc) {
//                execute 'cd /root && rm -rf HotSwapAgent.zip'
                put from:"$buildDir/distributions/hotSwapAgent.zip", into:'/root/HotSwapAgent.zip'
                execute 'cd /root && unzip -o hotSwapAgent.zip'
                execute 'cd /root/hotSwapAgent/ && chmod +x start.sh'
//                execute 'cd /root/HotSwapAgent/ && bash start.sh server --file ClassToRedefine.txt'
//                execute 'cd /root/HotSwapAgent/ && bash start.sh server -i 300'
                execute 'cd /root/hotSwapAgent/ && bash start.sh server -dt "2018-12-12 18:47:22"'
            }
        }
    }
}